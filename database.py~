# database.py
import logging
import sqlite3
import os
import config

price_db = "gpw_data.db"
reports_db = "raporty_finansowe.db"
price_db_path = os.path.join(config.data_path, price_db)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)


def get_db_price_connection():
    conn = sqlite3.connect(price_db_path)
    conn.row_factory = sqlite3.Row
    return conn


def get_db_reports_connection():
    conn = sqlite3.connect(reports_db)
    conn.row_factory = sqlite3.Row
    return conn


def init_price_db():
    conn = get_db_price_connection()
    cursor = conn.cursor()

    cursor.execute('''
    CREATE TABLE IF NOT EXISTS tickers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        ticker TEXT UNIQUE NOT NULL,
        company_name TEXT,
        sector TEXT
    )
    ''')
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS daily_quotes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        date TEXT NOT NULL,
        ticker TEXT NOT NULL,
        currency TEXT,
        open REAL,
        high REAL,
        low REAL,
        close REAL,
        change_percent TEXT,
        volume INTEGER,
        UNIQUE(date, ticker)
    )
    ''')
    conn.commit()
    conn.close()
    logging.info(f"Baza cen '{price_db}' zainicjalizowana.")


def init_reports_db():
    conn = get_db_reports_connection()
    cursor = conn.cursor()
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS raporty (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        spolka TEXT NOT NULL,
        pole TEXT NOT NULL,
        wartosci TEXT NOT NULL
    )
    ''')
    conn.commit()
    conn.close()
    logging.info(f"Baza raportów '{reports_db}' zainicjalizowana.")

def get_all_tickers():
    conn = get_db_price_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT ticker FROM tickers")
    tickers = [row[0] for row in cursor.fetchall()]
    conn.close()
    return tickers


def save_to_raporty_db(spolka: str, records: list):
    """Zapisuje raporty do SQLite."""
    conn = sqlite3.connect(reports_db)
    c = conn.cursor()
    for record in records:
        c.execute(
            "INSERT INTO raporty (spolka, pole, wartosci) VALUES (?, ?, ?)",
            (spolka, record["pole"], ", ".join(record["wartosci"]))
        )
    conn.commit()
    conn.close()
    logging.info(f"Zapisano {len(records)} rekordów dla spółki {spolka}")


def insert_daily_data(date_str: str, data: dict):
    """Wstawia dane dzienne do bazy danych."""
    conn = get_db_price_connection()
    cursor = conn.cursor()

    inserted_count = 0
    for ticker, values in data.items():
        try:
            # Czyszczenie i konwersja danych przed wstawieniem
            volume_str = values.get('volume', '0').replace(' ', '')
            volume = int(volume_str) if volume_str.isdigit() else 0

            # POPRAWKA: wycinamy spacje z cen przed konwersją na float
            open_price_str = values.get('open', '0.0').replace(',', '.').replace(' ', '')
            high_price_str = values.get('high', '0.0').replace(',', '.').replace(' ', '')
            low_price_str = values.get('low', '0.0').replace(',', '.').replace(' ', '')
            close_price_str = values.get('close', '0.0').replace(',', '.').replace(' ', '')

            open_price = float(open_price_str)
            high_price = float(high_price_str)
            low_price = float(low_price_str)
            close_price = float(close_price_str)

            cursor.execute('''
            INSERT INTO daily_quotes (date, ticker, currency, open, high, low, close, change_percent, volume)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT(date, ticker) DO NOTHING
            ''', (
                date_str,
                ticker,
                values.get('currency'),
                open_price,
                high_price,
                low_price,
                close_price,
                values.get('change_percent'),
                volume
            ))
            inserted_count += cursor.rowcount
        except (ValueError, sqlite3.IntegrityError) as e:
            print(f"Błąd przy wstawianiu danych dla {ticker} w dniu {date_str}: {e}")
            continue

    conn.commit()
    conn.close()
    print(f"Wstawiono {inserted_count} nowych rekordów do bazy danych dla daty {date_str}.")
